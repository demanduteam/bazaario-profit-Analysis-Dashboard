<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profit Analysis Dashboard</title>
    
    <!-- Core Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Jalali Date Library -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        vazir: ['Vazirmatn', 'sans-serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'fadeIn': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                },
            },
        }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
            background-color: #111827;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for tables */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body class="dark text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // ==================================================
        // Supabase Client Setup
        // ==================================================
        const { createClient } = window.supabase;
        const supabaseUrl = 'https://wehyjatotbzxargnxasg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaHlqYXRvdGJ6eGFyZ254YXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTIwMjEsImV4cCI6MjA2NzQ4ODAyMX0.2R448DuEBlTrNvaYXiYZ8D5M7MJNv7n1qmIDHQBNFiY';
        const supabaseClient = createClient(supabaseUrl, supabaseKey, { global: { fetch: window.fetch.bind(window) } });

        // ==================================================
        // Mock Data for Demo Mode (Fallback)
        // ==================================================
        const MOCK_DATA = [
            {
                id: 1001,
                createdat: new Date().toISOString(),
                totalamount: 15000000,
                discount: 500000,
                totalshippingprice: 200000,
                demandid: 501,
                customer: { fullname: "علی محمدی" },
                details: [
                    {
                        demand_item_id: 1,
                        productName: "گوشی موبایل سامسونگ S23",
                        quantity: 1,
                        sales_price: 14800000,
                        purchase_price: 13500000,
                        itemRevenue: 14800000,
                        itemCost: 13500000,
                        itemProfit: 1300000
                    }
                ],
                actualShippingCost: 150000,
                shippingProfitLoss: 50000,
                revenue: 15000000,
                cost: 14150000, 
                profit: 850000,
                poStatus: "محاسبه سود و زیان انجام شد"
            },
            {
                id: 1002,
                createdat: new Date(Date.now() - 86400000 * 5).toISOString(),
                totalamount: 8500000,
                discount: 0,
                totalshippingprice: 100000,
                demandid: 502,
                customer: { fullname: "سارا احمدی" },
                details: [
                    {
                        demand_item_id: 2,
                        productName: "هندزفری بلوتوثی",
                        quantity: 2,
                        sales_price: 4200000,
                        purchase_price: 3800000,
                        itemRevenue: 8400000,
                        itemCost: 7600000,
                        itemProfit: 800000
                    }
                ],
                actualShippingCost: 120000,
                shippingProfitLoss: -20000,
                revenue: 8500000,
                cost: 7720000,
                profit: 780000,
                poStatus: "در حال پردازش"
            }
        ];

        // ==================================================
        // Helper Functions & Constants
        // ==================================================
        const formatCurrency = (value) => {
            if (value === null || typeof value === 'undefined' || isNaN(value)) return '۰';
            return `${Number(Math.round(value)).toLocaleString('fa-IR')}`;
        };

        const formatDateJalali = (dateString) => {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('fa-IR-u-ca-persian');
        };

        const PERSIAN_MONTHS = [
            "فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور",
            "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"
        ];

        // ==================================================
        // Components
        // ==================================================

        const JalaliDatePicker = ({ label, value, onChange }) => {
            // 'value' prop is expected to be a Gregorian ISO string (YYYY-MM-DD)
            // If empty, defaults to today.

            // Helper to get initial Jalali parts from the Gregorian ISO string
            const getInitialParts = (isoDate) => {
                const date = isoDate ? new Date(isoDate) : new Date();
                const { jy, jm, jd } = jalaali.toJalaali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                return { jy, jm, jd };
            };

            const [parts, setParts] = React.useState(getInitialParts(value));

            // Sync with external value changes
            React.useEffect(() => {
                setParts(getInitialParts(value));
            }, [value]);

            const handleChange = (field, numVal) => {
                let newParts = { ...parts, [field]: parseInt(numVal) || 0 };
                
                // Basic validation constraints
                if (field === 'jm') {
                    if (newParts.jm > 12) newParts.jm = 12;
                    if (newParts.jm < 1) newParts.jm = 1;
                }
                if (field === 'jd') {
                    if (newParts.jd > 31) newParts.jd = 31;
                    if (newParts.jd < 1) newParts.jd = 1;
                }
                
                setParts(newParts);

                // Convert back to Gregorian ISO for the parent component
                try {
                    const { gy, gm, gd } = jalaali.toGregorian(newParts.jy, newParts.jm, newParts.jd);
                    const isoDate = `${gy}-${String(gm).padStart(2, '0')}-${String(gd).padStart(2, '0')}`;
                    onChange(isoDate);
                } catch (e) {
                    console.log("Invalid date conversion");
                }
            };

            return (
                <div className="flex flex-col gap-2">
                    <label className="text-sm font-medium text-gray-700 dark:text-gray-300">{label}</label>
                    <div className="flex bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-300 dark:border-gray-600 overflow-hidden" dir="ltr">
                        {/* Year */}
                        <input 
                            type="number" 
                            value={parts.jy}
                            onChange={(e) => handleChange('jy', e.target.value)}
                            className="w-16 p-2 bg-transparent text-center focus:bg-indigo-50 dark:focus:bg-indigo-900/30 outline-none border-r border-gray-300 dark:border-gray-600"
                            placeholder="سال"
                        />
                        {/* Month */}
                        <select 
                            value={parts.jm}
                            onChange={(e) => handleChange('jm', e.target.value)}
                            className="flex-1 p-2 bg-transparent text-center focus:bg-indigo-50 dark:focus:bg-indigo-900/30 outline-none border-r border-gray-300 dark:border-gray-600 appearance-none text-xs sm:text-sm"
                            dir="rtl"
                        >
                            {PERSIAN_MONTHS.map((m, idx) => (
                                <option key={idx} value={idx + 1} className="dark:bg-gray-800">{m}</option>
                            ))}
                        </select>
                        {/* Day */}
                        <select 
                            value={parts.jd}
                            onChange={(e) => handleChange('jd', e.target.value)}
                            className="w-14 p-2 bg-transparent text-center focus:bg-indigo-50 dark:focus:bg-indigo-900/30 outline-none appearance-none"
                        >
                            {Array.from({length: 31}, (_, i) => i + 1).map(d => (
                                <option key={d} value={d} className="dark:bg-gray-800">{d}</option>
                            ))}
                        </select>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, subtext, colorClass, borderClass }) => (
             <div className={`bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-b-4 ${borderClass}`}>
                <h3 className="text-gray-500 dark:text-gray-400 text-sm font-medium">{title}</h3>
                <p className={`text-xl lg:text-2xl font-bold mt-2 ${colorClass}`}>
                    {value} 
                    {subtext && <span className="text-xs lg:text-sm text-gray-400 font-normal mr-1">{subtext}</span>}
                </p>
            </div>
        );

        const ProfitAnalysisDashboard = () => {
            const [invoices, setInvoices] = React.useState([]);
            const [summary, setSummary] = React.useState({ 
                totalRevenue: 0, 
                totalCosts: 0, 
                totalProfit: 0, 
                totalShippingProfitLoss: 0,
                totalItemProfit: 0,
                invoiceCount: 0
            });
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [isDemoMode, setIsDemoMode] = React.useState(false);
            const [onlyCalculated, setOnlyCalculated] = React.useState(false);
            
            // Initial state: Last month to Today
            const [dateRange, setDateRange] = React.useState(() => {
                const end = new Date();
                const start = new Date();
                start.setMonth(start.getMonth() - 1);
                return {
                    start: start.toISOString().split('T')[0],
                    end: end.toISOString().split('T')[0]
                };
            });
            
            const [expandedInvoiceId, setExpandedInvoiceId] = React.useState(null);

            const handleDateChange = (field, value) => {
                setDateRange(prev => ({ ...prev, [field]: value }));
            };

            const toggleDetails = (invoiceId) => {
                setExpandedInvoiceId(prevId => (prevId === invoiceId ? null : invoiceId));
            };

            // ==================================================
            // EXCEL EXPORT FUNCTION
            // ==================================================
            const handleExportExcel = () => {
                if (invoices.length === 0) {
                    alert('داده‌ای برای خروجی وجود ندارد.');
                    return;
                }

                // --- Sheet 1: Summary ---
                const summaryData = [
                    ["گزارش تحلیل سود"],
                    ["تاریخ تهیه گزارش", new Date().toLocaleDateString('fa-IR')],
                    ["بازه زمانی", `از ${formatDateJalali(dateRange.start)} تا ${formatDateJalali(dateRange.end)}`],
                    ["فیلتر", onlyCalculated ? "فقط سفارش‌های محاسبه شده" : "همه سفارش‌ها"],
                    [],
                    ["شاخص", "مقدار (تومان)"],
                    ["درآمد کل", Math.round(summary.totalRevenue)],
                    ["هزینه کل", Math.round(summary.totalCosts)],
                    ["سود خالص نهایی", Math.round(summary.totalProfit)],
                    ["سود/زیان حمل", Math.round(summary.totalShippingProfitLoss)],
                    ["سود ناخالص کالا", Math.round(summary.totalItemProfit)],
                    ["تعداد فاکتور", summary.invoiceCount],
                    ["میانگین سود هر فاکتور", summary.invoiceCount ? Math.round(summary.totalProfit / summary.invoiceCount) : 0]
                ];

                // --- Sheet 2: Invoices List ---
                const invoiceHeader = ["شماره فاکتور", "مشتری", "تاریخ (شمسی)", "تاریخ (میلادی)", "درآمد کل", "هزینه کل", "سود خالص", "سود حمل", "تخفیف"];
                const invoiceRows = invoices.map(inv => [
                    inv.id,
                    inv.customer?.fullname || "نامشخص",
                    formatDateJalali(inv.createdat),
                    inv.createdat,
                    inv.revenue,
                    inv.cost,
                    inv.profit,
                    inv.shippingProfitLoss,
                    inv.discount || 0
                ]);

                // --- Sheet 3: Item Details (Flattened) ---
                const detailsHeader = ["شماره فاکتور", "نام محصول", "تعداد", "قیمت خرید واحد", "قیمت فروش واحد", "هزینه کل آیتم", "درآمد کل آیتم", "سود آیتم"];
                const detailsRows = invoices.flatMap(inv => 
                    inv.details.map(d => [
                        inv.id,
                        d.productName,
                        d.quantity,
                        d.purchase_price,
                        d.sales_price,
                        d.itemCost,
                        d.itemRevenue,
                        d.itemProfit
                    ])
                );

                // Create Workbook and Sheets
                const wb = XLSX.utils.book_new();

                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                const wsInvoices = XLSX.utils.aoa_to_sheet([invoiceHeader, ...invoiceRows]);
                const wsDetails = XLSX.utils.aoa_to_sheet([detailsHeader, ...detailsRows]);

                // Adjust column widths roughly
                wsSummary['!cols'] = [{wch: 25}, {wch: 20}];
                wsInvoices['!cols'] = [{wch: 15}, {wch: 20}, {wch: 15}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 10}];
                wsDetails['!cols'] = [{wch: 15}, {wch: 30}, {wch: 10}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];

                XLSX.utils.book_append_sheet(wb, wsSummary, "خلاصه");
                XLSX.utils.book_append_sheet(wb, wsInvoices, "فاکتورها");
                XLSX.utils.book_append_sheet(wb, wsDetails, "جزئیات کالا");

                // Write File
                XLSX.writeFile(wb, `Profit_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const loadDemoData = () => {
                setIsDemoMode(true);
                setError('');
                
                // Filter mock data if enabled
                const filteredData = MOCK_DATA.filter(inv => {
                    if (onlyCalculated && inv.poStatus !== 'محاسبه سود و زیان انجام شد') return false;
                    return true;
                });
                
                setInvoices(filteredData);
                
                // Calculate summary for mock data
                let totalItemProfit = 0;
                const mockSummary = filteredData.reduce((acc, inv) => {
                    const invItemProfit = inv.details.reduce((sum, d) => sum + d.itemProfit, 0);
                    totalItemProfit += invItemProfit;
                    return {
                        totalRevenue: acc.totalRevenue + inv.revenue,
                        totalCosts: acc.totalCosts + inv.cost,
                        totalProfit: acc.totalProfit + inv.profit,
                        totalShippingProfitLoss: acc.totalShippingProfitLoss + inv.shippingProfitLoss
                    };
                }, { totalRevenue: 0, totalCosts: 0, totalProfit: 0, totalShippingProfitLoss: 0 });
                
                setSummary({
                    ...mockSummary,
                    totalItemProfit,
                    invoiceCount: filteredData.length
                });
            };

            const fetchData = async () => {
                if (isDemoMode) {
                    loadDemoData();
                    return;
                }

                if (!dateRange.start || !dateRange.end) {
                    setError('لطفا بازه تاریخ را کامل کنید.');
                    return;
                }
                setIsLoading(true);
                setError('');
                setInvoices([]);
                setSummary({ totalRevenue: 0, totalCosts: 0, totalProfit: 0, totalShippingProfitLoss: 0, totalItemProfit: 0, invoiceCount: 0 });

                try {
                    // Step 1: Fetch invoices and their details
                    const { data: invoiceData, error: fetchError } = await supabaseClient
                        .from('demandinvoice')
                        .select(`
                            id,
                            createdat,
                            totalamount,
                            discount,
                            totalshippingprice,
                            demandid,
                            customer:customeruserid(fullname),
                            demandinvoicedetail(
                                demand_item_id,
                                quantity,
                                sales_price,
                                demand_item:demand_item_id(product:productid(title))
                            )
                        `)
                        .gte('createdat', new Date(dateRange.start).toISOString())
                        .lte('createdat', new Date(dateRange.end + 'T23:59:59Z').toISOString())
                        .order('createdat', { ascending: false });

                    if (fetchError) throw fetchError;
                    
                    if (!invoiceData || invoiceData.length === 0) {
                        setInvoices([]);
                        setIsLoading(false);
                        return;
                    }

                    // Step 2: Collect all unique demand_item_ids and demand_ids
                    const allDemandItemIds = invoiceData.flatMap(inv => inv.demandinvoicedetail.map(d => d.demand_item_id));
                    const uniqueDemandItemIds = [...new Set(allDemandItemIds)];
                    const uniqueDemandIds = [...new Set(invoiceData.map(inv => inv.demandid))];

                    // Step 3: Fetch purchase prices from PO details
                    const { data: poDetails, error: poDetailsError } = await supabaseClient
                        .from('purchase_order_details')
                        .select('demand_item_id, purchase_price')
                        .in('demand_item_id', uniqueDemandItemIds);
                    if (poDetailsError) throw poDetailsError;
                    const priceMap = new Map(poDetails.map(item => [item.demand_item_id, item.purchase_price]));

                    // Step 4: Fetch actual shipping costs AND STATUS from POs
                    const { data: poData, error: poDataError } = await supabaseClient
                        .from('purchase_orders')
                        .select('demandid, actual_shipping_cost, status')
                        .in('demandid', uniqueDemandIds);
                    if (poDataError) throw poDataError;
                    
                    const shippingCostMap = new Map();
                    const poStatusMap = new Map(); // Store status

                    poData.forEach(po => {
                        // Aggregate shipping costs if multiple POs exist for one demand
                        if (po.actual_shipping_cost > 0) {
                            const currentCost = shippingCostMap.get(po.demandid) || 0;
                            shippingCostMap.set(po.demandid, currentCost + po.actual_shipping_cost);
                        }
                        // Store status (assuming last one wins or single PO)
                        if (po.status) {
                             poStatusMap.set(po.demandid, po.status);
                        }
                    });

                    // Step 5: Process invoices with all cost data
                    let totalRevenue = 0;
                    let totalCosts = 0;
                    let totalShippingProfitLoss = 0;
                    let totalItemProfit = 0;
                    
                    // Filter and map in one go
                    const processedInvoices = invoiceData.reduce((acc, invoice) => {
                        // FILTER LOGIC
                        const poStatus = poStatusMap.get(invoice.demandid);
                        if (onlyCalculated && poStatus !== 'محاسبه سود و زیان انجام شد') {
                            return acc; // Skip this invoice
                        }

                        let invoiceCostOfGoods = 0;
                        let invoiceItemProfit = 0;
                        
                        const details = invoice.demandinvoicedetail.map(detail => {
                            const purchasePrice = priceMap.get(detail.demand_item_id) || 0;
                            const itemCost = purchasePrice * detail.quantity;
                            invoiceCostOfGoods += itemCost;
                            const itemProfit = (detail.sales_price * detail.quantity) - itemCost;
                            invoiceItemProfit += itemProfit;
                            return {
                                demand_item_id: detail.demand_item_id,
                                productName: detail.demand_item?.product?.title || 'محصول نامشخص',
                                quantity: detail.quantity,
                                sales_price: detail.sales_price,
                                purchase_price: purchasePrice,
                                itemRevenue: detail.sales_price * detail.quantity,
                                itemCost,
                                itemProfit,
                            };
                        });
                        
                        const actualShippingCost = shippingCostMap.get(invoice.demandid) || 0;
                        const shippingRevenue = invoice.totalshippingprice || 0;
                        const shippingProfitLoss = shippingRevenue - actualShippingCost;

                        const invoiceRevenue = invoice.totalamount;
                        const totalInvoiceCost = invoiceCostOfGoods + (invoice.discount || 0) + actualShippingCost;
                        const invoiceProfit = invoiceRevenue - totalInvoiceCost;
                        
                        totalRevenue += invoiceRevenue;
                        totalCosts += totalInvoiceCost;
                        totalShippingProfitLoss += shippingProfitLoss;
                        totalItemProfit += invoiceItemProfit;

                        acc.push({
                            ...invoice,
                            revenue: invoiceRevenue,
                            cost: totalInvoiceCost,
                            profit: invoiceProfit,
                            actualShippingCost,
                            shippingProfitLoss,
                            details,
                        });
                        return acc;
                    }, []);

                    setInvoices(processedInvoices);
                    setSummary({ 
                        totalRevenue, 
                        totalCosts, 
                        totalProfit: totalRevenue - totalCosts, 
                        totalShippingProfitLoss,
                        totalItemProfit,
                        invoiceCount: processedInvoices.length
                    });

                } catch (err) {
                    console.error("Error fetching profit data:", err);
                    setError(
                        <span>
                            خطا در اتصال به دیتابیس: {err.message || 'خطای ناشناخته'}.<br/>
                            <button 
                                onClick={loadDemoData} 
                                className="mt-2 text-indigo-400 underline hover:text-indigo-300"
                            >
                                استفاده از داده‌های آزمایشی (Demo Mode)
                            </button>
                        </span>
                    );
                } finally {
                    setIsLoading(false);
                }
            };
            
            // Re-fetch when filter changes, or just re-filter if we stored raw data? 
            // For simplicity and accuracy with DB, we re-fetch/re-process.
            React.useEffect(() => {
                fetchData();
            }, [onlyCalculated]); // Add onlyCalculated to dependency array
            
            // Calculate Averages
            const avgRevenue = summary.invoiceCount ? summary.totalRevenue / summary.invoiceCount : 0;
            const avgNetProfit = summary.invoiceCount ? summary.totalProfit / summary.invoiceCount : 0;
            const avgShippingProfit = summary.invoiceCount ? summary.totalShippingProfitLoss / summary.invoiceCount : 0;
            const avgItemProfit = summary.invoiceCount ? summary.totalItemProfit / summary.invoiceCount : 0;

            const renderInvoiceDetails = (invoice) => (
                <div className="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-b-lg animate-fadeIn">
                    <h4 className="font-bold mb-3 text-md text-gray-800 dark:text-gray-200">جزئیات محاسبه سود</h4>
                    <div className="space-y-3">
                        {invoice.details.map(detail => (
                            <div key={detail.demand_item_id} className="p-3 bg-white dark:bg-gray-800 rounded-lg text-sm border dark:border-gray-600 shadow-sm">
                                <p className="font-semibold mb-2 text-gray-800 dark:text-gray-200">{detail.productName}</p>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-600 dark:text-gray-400">
                                    <p>تعداد: {detail.quantity}</p>
                                    <p>قیمت فروش: {formatCurrency(detail.sales_price)}</p>
                                    <p>درآمد آیتم: {formatCurrency(detail.itemRevenue)}</p>
                                    <p>قیمت خرید: {formatCurrency(detail.purchase_price)}</p>
                                    <p>هزینه آیتم: {formatCurrency(detail.itemCost)}</p>
                                    <p className={`font-bold ${detail.itemProfit < 0 ? 'text-red-500' : 'text-green-500'}`}>سود آیتم: {formatCurrency(detail.itemProfit)}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-4 pt-3 border-t dark:border-gray-600 text-sm space-y-2">
                        <div className="flex justify-between text-gray-700 dark:text-gray-300">
                            <span>جمع سود آیتم‌ها:</span>
                            <span className="font-semibold">{formatCurrency(invoice.details.reduce((sum, d) => sum + d.itemProfit, 0))} تومان</span>
                        </div>
                        <div className="flex justify-between text-gray-700 dark:text-gray-300">
                            <span>هزینه حمل مشتری:</span>
                            <span className="font-semibold">{formatCurrency(invoice.totalshippingprice || 0)} تومان</span>
                        </div>
                        <div className="flex justify-between text-red-500">
                            <span>هزینه حمل تامین‌کننده:</span>
                            <span className="font-semibold">- {formatCurrency(invoice.actualShippingCost || 0)} تومان</span>
                        </div>
                        <div className={`flex justify-between font-semibold ${invoice.shippingProfitLoss < 0 ? 'text-red-500' : 'text-green-500'}`}>
                            <span>سود/زیان حمل:</span>
                            <span>{formatCurrency(invoice.shippingProfitLoss || 0)} تومان</span>
                        </div>
                        <div className="flex justify-between text-red-500">
                            <span>تخفیف فاکتور:</span>
                            <span className="font-semibold">- {formatCurrency(invoice.discount || 0)} تومان</span>
                        </div>
                        <div className={`flex justify-between font-bold text-lg mt-2 pt-2 border-t dark:border-gray-500 ${invoice.profit < 0 ? 'text-red-500' : 'text-green-500'}`}>
                            <span>سود نهایی فاکتور:</span>
                            <span>{formatCurrency(invoice.profit)} تومان</span>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="p-4 md:p-8 text-gray-900 dark:text-gray-100 min-h-screen font-vazir">
                    <header className="mb-8 flex justify-between items-center">
                        <div>
                            <h1 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-l from-blue-400 to-indigo-600">داشبورد تحلیل سود</h1>
                            <p className="text-gray-500 dark:text-gray-400 mt-1">عملکرد مالی کسب و کار خود را بررسی کنید.</p>
                        </div>
                        {isDemoMode && (
                            <span className="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full border border-yellow-300">
                                حالت آزمایشی (Demo)
                            </span>
                        )}
                    </header>

                    <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border dark:border-gray-700 mb-8">
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
                            <JalaliDatePicker 
                                label="از تاریخ"
                                value={dateRange.start}
                                onChange={(val) => handleDateChange('start', val)}
                            />
                            <JalaliDatePicker 
                                label="تا تاریخ"
                                value={dateRange.end}
                                onChange={(val) => handleDateChange('end', val)}
                            />
                            
                             {/* Filter Checkbox */}
                            <div className="flex items-center h-10 px-2">
                                <label className="flex items-center gap-2 cursor-pointer select-none">
                                    <div className="relative">
                                        <input 
                                            type="checkbox" 
                                            className="sr-only"
                                            checked={onlyCalculated}
                                            onChange={(e) => setOnlyCalculated(e.target.checked)}
                                        />
                                        <div className={`block w-10 h-6 rounded-full transition-colors ${onlyCalculated ? 'bg-indigo-600' : 'bg-gray-300 dark:bg-gray-600'}`}></div>
                                        <div className={`dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform ${onlyCalculated ? 'transform translate-x-4' : ''}`}></div>
                                    </div>
                                    <span className="text-sm font-medium text-gray-700 dark:text-gray-300">
                                        فقط سفارش‌های محاسبه شده
                                    </span>
                                </label>
                            </div>

                            <div className="flex gap-2 h-10 self-end">
                                <button onClick={() => { setIsDemoMode(false); fetchData(); }} disabled={isLoading} className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors shadow-md disabled:bg-indigo-400 disabled:cursor-wait text-sm">
                                    {isLoading ? '...' : 'بروزرسانی'}
                                </button>
                                <button onClick={handleExportExcel} disabled={isLoading || invoices.length === 0} className="px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors shadow-md disabled:bg-green-800 disabled:opacity-50 text-sm flex items-center justify-center gap-1" title="خروجی اکسل">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    <span>اکسل</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {isLoading && <div className="spinner"></div>}
                    
                    {error && (
                        <div className="text-center p-6 text-red-500 bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl mb-8">
                            <p className="font-bold text-lg mb-2">خطا</p>
                            <p>{error}</p>
                        </div>
                    )}
                    
                    {(!isLoading && !error) && (
                        <div className="animate-fade-in-up space-y-6">
                            {/* Row 1: Totals */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                                <StatCard title="درآمد کل" value={formatCurrency(summary.totalRevenue)} subtext="تومان" colorClass="text-gray-800 dark:text-white" borderClass="border-blue-500" />
                                <StatCard title="هزینه کل" value={formatCurrency(summary.totalCosts)} subtext="تومان" colorClass="text-gray-800 dark:text-white" borderClass="border-red-500" />
                                <StatCard title="سود/زیان حمل" value={formatCurrency(summary.totalShippingProfitLoss)} subtext="تومان" colorClass={summary.totalShippingProfitLoss < 0 ? 'text-orange-500' : 'text-emerald-500'} borderClass={summary.totalShippingProfitLoss < 0 ? 'border-orange-500' : 'border-emerald-500'} />
                                <StatCard title="سود کل نهایی" value={formatCurrency(summary.totalProfit)} subtext="تومان" colorClass={summary.totalProfit < 0 ? 'text-red-500' : 'text-green-500'} borderClass={summary.totalProfit < 0 ? 'border-red-600' : 'border-green-500'} />
                            </div>

                            {/* Row 2: Averages & Counts */}
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                <div className="bg-indigo-50 dark:bg-gray-800 p-4 rounded-xl shadow border dark:border-gray-700 flex flex-col justify-center items-center text-center">
                                    <span className="text-xs text-indigo-500 dark:text-indigo-400 font-bold uppercase tracking-wider mb-1">تعداد فاکتور</span>
                                    <span className="text-2xl font-black text-gray-800 dark:text-gray-100">{summary.invoiceCount}</span>
                                </div>
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-t-2 border-blue-400 text-center">
                                    <span className="text-xs text-gray-500 dark:text-gray-400 block mb-1">میانگین درآمد / فاکتور</span>
                                    <span className="text-lg font-bold text-blue-600 dark:text-blue-400">{formatCurrency(avgRevenue)}</span>
                                </div>
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-t-2 border-indigo-400 text-center">
                                    <span className="text-xs text-gray-500 dark:text-gray-400 block mb-1">میانگین سود کالا (فروش)</span>
                                    <span className="text-lg font-bold text-indigo-600 dark:text-indigo-400">{formatCurrency(avgItemProfit)}</span>
                                </div>
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-t-2 border-orange-400 text-center">
                                    <span className="text-xs text-gray-500 dark:text-gray-400 block mb-1">میانگین سود حمل</span>
                                    <span className={`text-lg font-bold ${avgShippingProfit < 0 ? 'text-orange-500' : 'text-green-500'}`}>{formatCurrency(avgShippingProfit)}</span>
                                </div>
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-t-2 border-green-400 text-center col-span-2 sm:col-span-1">
                                    <span className="text-xs text-gray-500 dark:text-gray-400 block mb-1">میانگین سود خالص / فاکتور</span>
                                    <span className={`text-lg font-bold ${avgNetProfit < 0 ? 'text-red-500' : 'text-green-500'}`}>{formatCurrency(avgNetProfit)}</span>
                                </div>
                            </div>
                            
                            {/* Detailed Invoice List */}
                            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border dark:border-gray-700">
                                <div className="p-5 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                                    <h2 className="text-xl font-bold">لیست فاکتورها</h2>
                                </div>
                                
                                {/* Desktop Table */}
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-right">
                                        <thead className="bg-gray-100 dark:bg-gray-900/50 text-gray-600 dark:text-gray-400 text-sm">
                                            <tr>
                                                <th className="p-4 font-semibold">شماره فاکتور</th>
                                                <th className="p-4 font-semibold">مشتری</th>
                                                <th className="p-4 font-semibold">تاریخ</th>
                                                <th className="p-4 font-semibold">درآمد</th>
                                                <th className="p-4 font-semibold">هزینه</th>
                                                <th className="p-4 font-semibold">سود</th>
                                                <th className="p-4 font-semibold">عملیات</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                            {invoices.map(invoice => (
                                                <React.Fragment key={invoice.id}>
                                                    <tr className={`transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/30 ${expandedInvoiceId === invoice.id ? 'bg-gray-50 dark:bg-gray-700/50' : ''}`}>
                                                        <td className="p-4 font-mono text-sm opacity-70">#{invoice.id}</td>
                                                        <td className="p-4 font-medium">{invoice.customer?.fullname || 'نامشخص'}</td>
                                                        <td className="p-4 text-sm">{formatDateJalali(invoice.createdat)}</td>
                                                        <td className="p-4 text-blue-500 font-medium">{formatCurrency(invoice.revenue)}</td>
                                                        <td className="p-4 text-red-500 font-medium">{formatCurrency(invoice.cost)}</td>
                                                        <td className={`p-4 font-bold ${invoice.profit < 0 ? 'text-red-500' : 'text-green-500'}`}>{formatCurrency(invoice.profit)}</td>
                                                        <td className="p-4">
                                                            <button onClick={() => toggleDetails(invoice.id)} className="text-indigo-600 dark:text-indigo-400 text-sm font-semibold hover:underline">
                                                                {expandedInvoiceId === invoice.id ? 'بستن' : 'جزئیات'}
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {expandedInvoiceId === invoice.id && (
                                                        <tr>
                                                            <td colSpan="7" className="p-0 border-b dark:border-gray-700">
                                                                {renderInvoiceDetails(invoice)}
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Mobile Card View */}
                                <div className="md:hidden">
                                     {invoices.map(invoice => (
                                        <div key={invoice.id} className="border-b dark:border-gray-700 last:border-0">
                                            <div className="p-4">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <span className="text-xs font-mono text-gray-400">#{invoice.id}</span>
                                                        <h3 className="font-bold text-gray-800 dark:text-gray-200">{invoice.customer?.fullname || 'نامشخص'}</h3>
                                                    </div>
                                                    <span className="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-600 dark:text-gray-300">
                                                        {formatDateJalali(invoice.createdat)}
                                                    </span>
                                                </div>
                                                
                                                <div className="grid grid-cols-3 gap-2 text-center text-sm mb-4 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg">
                                                    <div>
                                                        <p className="text-xs text-gray-500 mb-1">درآمد</p>
                                                        <p className="font-bold text-blue-500 text-xs sm:text-sm">{formatCurrency(invoice.revenue)}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-gray-500 mb-1">هزینه</p>
                                                        <p className="font-bold text-red-500 text-xs sm:text-sm">{formatCurrency(invoice.cost)}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-gray-500 mb-1">سود</p>
                                                        <p className={`font-bold text-xs sm:text-sm ${invoice.profit < 0 ? 'text-red-500' : 'text-green-500'}`}>{formatCurrency(invoice.profit)}</p>
                                                    </div>
                                                </div>
                                                
                                                <button onClick={() => toggleDetails(invoice.id)} className="w-full py-2 flex items-center justify-center text-sm font-medium text-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-colors">
                                                    {expandedInvoiceId === invoice.id ? 'بستن جزئیات' : 'مشاهده جزئیات محاسبه'}
                                                </button>
                                            </div>
                                            {expandedInvoiceId === invoice.id && (
                                                <div className="border-t dark:border-gray-700">
                                                    {renderInvoiceDetails(invoice)}
                                                </div>
                                            )}
                                        </div>
                                     ))}
                                </div>
                                {invoices.length === 0 && <p className="text-center py-12 text-gray-500 dark:text-gray-400">هیچ فاکتوری با شرایط فعلی یافت نشد.</p>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<ProfitAnalysisDashboard />);
    </script>
</body>
</html>